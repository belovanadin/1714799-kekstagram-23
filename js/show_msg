import { request } from './fetch.js';
import {closeForm} from './form.js';

const body = document.querySelector('body');
const formUpload = document.querySelector('.img-upload__form');
const successMessage = document.querySelector('#success').content.querySelector('.success');
const errorMessage = document.querySelector('#error').content.querySelector('.error');
const successButton = document.querySelector('.success__button');
const errorButton = document.querySelector('.error__button');

const closePopupMessage = () => {
  const popupMessage = document.body.querySelector('.error') || document.body.querySelector('.success');
  popupMessage.remove();
  // eslint-disable-next-line no-use-before-define
  document.removeEventListener('keydown', onMessageEscKeydown);
  // eslint-disable-next-line no-use-before-define
  document.removeEventListener('click', onDocumentClick);
};

const onDocumentClick = (evt) => {
  const popupMessage = successButton || errorButton;
  if (evt.target === popupMessage) {
    closePopupMessage();
  }
};

const onMessageEscKeydown = (evt) => {
  if (evt.key === 'Escape' || evt.key === 'Esc') {
    closePopupMessage();
  }
};

const showSuccessMessage = () => {
  const messageElement = successMessage.cloneNode(true);
  body.appendChild(messageElement);
  document.addEventListener('keydown', onMessageEscKeydown);
  document.addEventListener('click', onDocumentClick);
};
const showErrorMessage = () => {
  const messageElement = errorMessage.cloneNode(true);
  body.appendChild(messageElement);
  document.addEventListener('keydown', onMessageEscKeydown);
  document.addEventListener('click', onDocumentClick);
};

formUpload.addEventListener('submit', (evt) => {
  evt.preventDefault();
  const formData = new FormData(evt.target);
  const onSuccess = () => {
    closeForm();
    showSuccessMessage();
    showErrorMessage();
  };
  const onError = () => {
  };
  request(onSuccess, onError, 'POST', formData);
});
